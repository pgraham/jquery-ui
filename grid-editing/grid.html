<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Editing, Inline Grid</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="../grid-spf/grid.css">
	<script src="../jquery-1.5.1.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../external/jquery.mousewheel-3.0.4.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../ui/jquery.ui.spinner.js"></script>
	<script src="../ui/jquery.ui.position.js"></script>
	<script src="../ui/jquery.ui.tooltip.js"></script>
	<script src="../grid-spf/datasource.js"></script>
	<script src="../grid-spf/datasource-local.js"></script>
	<script src="../grid-spf/grid.js"></script>
	<script src="../grid-spf/pager.js"></script>
	<script src="editor.js"></script>
	<script src="grid-editor.js"></script>
	<script src="navigator.js"></script>
	<script src="localstore.js"></script>
	<script src="helpers.js"></script>
	<script>
	if ( !window.console ) {
		window.console = {
			log: function() {
				var message = Array.prototype.slice.call( arguments, 1 ).join( ", " );
				$("<div>").text( message ).appendTo("body");
			}
		}
	}

	var store = $.demos.localstore( {
		key: "grid-editing-developers",
		initial: "../grid-spf/developers.json"
	});
	var localDevelopers = store.load();

	$(function() {
		var developers = $.ui.localDatasource({
			input: localDevelopers,
			paging: {
				limit: 8
			},
			propertychange: function(event, ui) {
				console.log("field", ui.path, "changed from", ui.oldValue, "to", ui.newValue);
			},
			objectchange: function(event, ui) {
				console.log("developer at index", ui.index, "changed", ui.object);
				this.save().refresh();
			},
			change: function(event, ui) {
				console.log("developer(s) at index", ui.index, ui.change + "ed", ui.items);
				this.save().refresh();
			}
		});
		developers.save = function() {
			store.save( localDevelopers );
			return this;
		}

		var grid = $.ui.grid( {
			source: developers
		}, "#developers-local" );

		grid.element.gridEditor({
			items: "td:not(:has(button))",
			type: function(cell) {
				// TODO should be possible to retrieve this from grid.options.columns
				return grid.element.find( "th" ).eq( cell[ 0 ].cellIndex ).data( "type" );
			},
			submit: function( event, ui) {
				var object = ui.item.tmplItem().data,
					field = grid.element.find( "th" ).eq( ui.item[ 0 ].cellIndex ).data( "field" ),
					oldValue = get(object, field);
				set(object, field, ui.value);
				developers._trigger("propertychange", event, {
					path: field,
					oldValue: oldValue,
					newValue: ui.value
				});
				// for the navigator
				grid.element.focus();
			}
		});
		grid.element.navigator();

		var developer, tmplItem;
		var editForm = $( "#editForm" ).hide().submit( function( event ) {
			event.preventDefault();
			serializeForm( this, developer );
			developers._trigger("objectchange", event, {
				index: localDevelopers.indexOf(developer),
				object: developer
			});
			editForm.hide();
		});
		grid.element.delegate( "button.edit", "click", function() {
			tmplItem = $( this ).tmplItem();
			developer = tmplItem.data;
			$( "#edit-tmpl" ).tmpl( meta(developer) ).appendTo( editForm.find("fieldset").empty() );
			editForm.show();
		});
		grid.element.delegate( "button.remove", "click", function() {
			var developer = $( this ).tmplItem().data;
			var index = localDevelopers.indexOf( developer );
			localDevelopers.splice( index, 1 );
			developers._trigger("change", event, {
				change: "remove",
				index: index,
				items: [ developer ]
			});
		});

		$( "#pageDevelopers" ).pager({
			source: developers
		});

		$( "#addDeveloper" ).click( function() {
			// add at front so that it becomes visible without paging
			localDevelopers.unshift({
				firstName: "Peter",
				lastName: "Pan",
				country: "Unknown",
				bitcoins: 0,
				random: {
					value: 0
				}
			});
			developers._trigger("change", event, {
				change: "insert",
				index: 0,
				items: [localDevelopers[0]]
			});
		});

		$("form").tooltip();

		developers.refresh();

		$.widget("ui.datalist", {
			_create: function() {
				$.ui.datalist.lists.push(this.options);
			}
		});
		$.ui.datalist.lists = [];
		$.ui.datalist({
			name: "countries",
			items: ["USA", "Germany", "China", "Canada", "UK", "Australia", "Austria"]
		});
	});
	</script>
	<style>
		.navigator-active { background: rgba(0,0,255,0.1); }
	</style>
</head>
<body>

<h1>Grids with editable local datasource</h1>

<h2>local data source</h2>
<p id="pageDevelopers">
	<button data-page="first">First</button>
	<button data-page="prev">Prev</button>
	<button data-page="prevStep">-1</button>
	<span>
		Page <input class="current" size="4"/>/<span class="total">0</span>,
		Total records <span class="totalRecords">0</span>
	</span>
	<button data-page="nextStep">+1</button>
	<button data-page="next">Next</button>
	<button data-page="last">Last</button>
</p>
<table id="developers-local">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country" data-list="countries">Country</th>
			<th data-field="bitcoins" data-type="number">Bitcoins</th>
			<th data-field="random.value" data-type="number">Random</th>
			<th data-template="#cell-edit-tmpl">Edit</th>
			<th data-template="#cell-remove-tmpl">Remove</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div>
	<button id="addDeveloper">Insert new developer</button>
</div>
<form id="editForm">
	<fieldset>
	</fieldset>
	<input type="submit" value="Save changes" />
</form>
<script id="edit-tmpl" type="text/x-jquery-tmpl">
{{if $.isArray(value)}}
	<ul>
		{{each(index, valueX) value}}
			<li><input type="text" name="${name}" placeholder="${label}" value="${valueX}" title="${label}" /></li>
		{{/each}}
	</ul>
{{else}}
	<input type="text" name="${name}" placeholder="${label}" value="${value}" title="${label}" />
{{/if}}
</script>
<script id="cell-edit-tmpl" type="text/x-jquery-tmpl">
	<td><button class='edit'>Edit</button></td>
</script>
<script id="cell-remove-tmpl" type="text/x-jquery-tmpl">
	<td><button class='remove'>Remove</button></td>
</script>

</body>
</html>
